<!DOCTYPE html>
<html lang="zxx">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="./assets/img/basic/favicon.ico" type="image/x-icon">
    <title>XV Victoria</title>
    <!-- CSS -->
    <link rel="stylesheet" href="./assets/css/app.css">
    <link rel="stylesheet" href="./assets/css/loading.css">
    <link rel="stylesheet" href="./assets/css/style.css?ver=1.0.1">

    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .swal2-title {
            color: #fff !important;
        }
    </style>
</head>

<body class="sidebar-mini sidebar-collapse theme-dark  sidebar-expanded-on-hover has-preloader" style="display: none;">
    <!-- Pre loader
  To disable preloader remove 'has-preloader' from body
 -->

    <div id="loader" class="loader">
        <div class="loader-container">
            <div class="preloader-wrapper big active">
                <div class="spinner-layer spinner-blue">
                    <div class="circle-clipper left">
                        <div class="circle"></div>
                    </div>
                    <div class="gap-patch">
                        <div class="circle"></div>
                    </div>
                    <div class="circle-clipper right">
                        <div class="circle"></div>
                    </div>
                </div>

                <div class="spinner-layer spinner-red">
                    <div class="circle-clipper left">
                        <div class="circle"></div>
                    </div>
                    <div class="gap-patch">
                        <div class="circle"></div>
                    </div>
                    <div class="circle-clipper right">
                        <div class="circle"></div>
                    </div>
                </div>

                <div class="spinner-layer spinner-yellow">
                    <div class="circle-clipper left">
                        <div class="circle"></div>
                    </div>
                    <div class="gap-patch">
                        <div class="circle"></div>
                    </div>
                    <div class="circle-clipper right">
                        <div class="circle"></div>
                    </div>
                </div>

                <div class="spinner-layer spinner-green">
                    <div class="circle-clipper left">
                        <div class="circle"></div>
                    </div>
                    <div class="gap-patch">
                        <div class="circle"></div>
                    </div>
                    <div class="circle-clipper right">
                        <div class="circle"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loader -->
    <!-- <div class="preloader">
        <div class="status">
            <lottie-player src="./assets/json/invitacion2.json" background="transparent" speed="1"
                style="width: 400px; height: 400px;" loop autoplay></lottie-player>
        </div>
    </div>

    <div class="preloader2" style="display: none">
        <div class="status2" style="width: 100%">
            <lottie-player src="./assets/json/confeti.json" background="transparent" speed="1"
                style="width: 100%; height: 100%;" loop autoplay></lottie-player>
        </div>
    </div> -->
    <!-- End loader -->

    <!-- @Pre loader-->
    <div id="rekord-app">


        <aside class="main-sidebar fixed offcanvas shadow" data-toggle='offcanvas'>
            <div class="sidebar">
                <!-- <ul class="sidebar-menu">
                    <li><a class="ajaxifyPage active" href="#inicio">
                            <i class="icon-home s-24 mr-2"></i> <span> Inicio</span>
                        </a>
                    </li>
                    <li><a class="ajaxifyPage" href="#invitacion">
                            <i class="icon-qrcode  s-24 mr-2"></i> <span> Invitación</span>
                        </a>
                    <li>
                    <li><a class="ajaxifyPage" href="#direccion">
                            <i class="icon-map-marker s-24 mr-2"></i> <span> Dirección</span>
                        </a>
                    <li>
                </ul> -->
            </div>
        </aside>
        <!--Sidebar End-->

        <!-- Right Sidebar -->
        <!-- <aside class="control-sidebar fixed ">
            <div class="slimScroll">
                <div class="sidebar-header">
                    <h4>PlayList</h4>
                    <p>Awesome Collection for you</p>
                    <a href="#" data-toggle="control-sidebar" class="paper-nav-toggle  active"><i></i></a>
                </div>
                <div class="p-3">
                    <ul id="playlist" class="playlist list-group">
                        <li class="list-group-item my-1">
                            <a class="no-ajaxy media-url" href="./assets/media/track1.mp3"
                                data-wave="./assets/media/track1.json">
                                <div class="d-flex justify-content-between align-items-center">
                                    <i class="icon-play s-28"></i>
                                    <figure class="avatar-md float-left mr-3 mt-1">
                                        <img class="r-5" src="./assets/img/demo/a1.jpg" alt="">
                                    </figure>
                                    <div>
                                        <h6>alexander Pierce</h6>Atif Aslam
                                    </div>
                                    <span class="badge badge-primary badge-pill"> 5:03</span>
                                </div>
                            </a>
                        </li>
                        <li class="list-group-item my-1">
                            <a class="no-ajaxy media-url" href="./assets/media/track2.mp3"
                                data-wave="./assets/media/track2.json">
                                <div class="d-flex justify-content-between align-items-center">
                                    <i class="icon-play s-28"></i>
                                    <figure class="avatar-md float-left mr-3 mt-1">
                                        <img class="r-5" src="./assets/img/demo/a2.jpg" alt="">
                                    </figure>
                                    <div>
                                        <h6>alexander Pierce</h6>Atif Aslam
                                    </div>
                                    <span class="badge badge-primary badge-pill"> 5:03</span>
                                </div>
                            </a>
                        </li>
                        <li class="list-group-item my-1">
                            <a class="no-ajaxy media-url" href="./assets/media/track3.mp3"
                                data-wave="./assets/media/track3.json">
                                <div class="d-flex justify-content-between align-items-center">
                                    <i class="icon-play s-28"></i>
                                    <figure class="avatar-md float-left mr-3 mt-1">
                                        <img class="r-5" src="./assets/img/demo/a4.jpg" alt="">
                                    </figure>
                                    <div>
                                        <h6>alexander Pierce</h6>Atif Aslam
                                    </div>
                                    <span class="badge badge-primary badge-pill"> 5:03</span>
                                </div>
                            </a>
                        </li>

                        <li class="list-group-item my-1">
                            <a class="no-ajaxy media-url" href="./assets/media/track1.mp3"
                                data-wave="./assets/media/track1.json">
                                <div class="d-flex justify-content-between align-items-center">
                                    <i class="icon-play s-28"></i>
                                    <figure class="avatar-md float-left mr-3 mt-1">
                                        <img class="r-5" src="./assets/img/demo/a5.jpg" alt="">
                                    </figure>
                                    <div>
                                        <h6>alexander Pierce</h6>Atif Aslam
                                    </div>
                                    <span class="badge badge-primary badge-pill"> 5:03</span>
                                </div>
                            </a>
                        </li>

                        <li class="list-group-item my-1">
                            <a class="no-ajaxy media-url" href="./assets/media/track2.mp3"
                                data-wave="./assets/media/track2.json">
                                <div class="d-flex justify-content-between align-items-center">
                                    <i class="icon-play s-28"></i>
                                    <figure class="avatar-md float-left mr-3 mt-1">
                                        <img class="r-5" src="./assets/img/demo/a6.jpg" alt="">
                                    </figure>
                                    <div>
                                        <h6>alexander Pierce</h6>Atif Aslam
                                    </div>
                                    <span class="badge badge-primary badge-pill"> 5:03</span>
                                </div>
                            </a>
                        </li>


                    </ul>

                </div>
            </div>
        </aside> -->
        <!-- /.right-sidebar -->
        <!-- Add the sidebar's background. This div must be placed
         immediately after the control sidebar -->
        <div class="control-sidebar-bg shadow  fixed"></div>

        <svg class="d-none">
            <defs>
                <symbol id="icon-cross" viewBox="0 0 24 24">
                    <title>cross</title>
                    <path
                        d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
                </symbol>
            </defs>
        </svg>

        <!--Page Content-->
        <main id="pageContent" class="page has-sidebar">
            <div class="container-fluid relative animatedParent animateOnce p-lg-5 " style="min-height: 100vh;">
                <!-- <h1 class="text-center">NO TIENES PERMISO PARA VER ESTO</h1> -->
                <div class="card no-b shadow no-r" style="min-height: 80vh !important;">
                    <div class="row no-gutters">
                        <div class="col-md-4 b-r">
                            <div class="text-center p-5 mt-5">
                                <figure class="avatar avatar-xl">
                                    <img src="assets/img/demo/u7.jpg" alt="">
                                </figure>
                                <div>
                                    <h2 class="p-t-10" id="familia">
                                        </h1>
                                </div>

                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="p5 b-b">
                                <div class="row">
                                    <div class="col-lg-4 col-md-6 col-6">
                                        <div class="p-4">
                                            <h2 class="text-primary">Pases</h1>
                                                <h3 id="pases"></h3>
                                        </div>
                                    </div>
                                    <div class="col-lg-4 col-md-6 col-6">
                                        <div class="p-4">
                                            <h2 class="text-primary">Adultos</h1>
                                                <h3 id="adultos"></h3>
                                        </div>
                                    </div>
                                    <div class="col-lg-4 col-md-6 col-6">
                                        <div class="p-4">
                                            <h2 class="text-primary">Niños</h1>
                                                <h3 id="ninos"></h3>
                                        </div>
                                    </div>


                                    <div class="col-lg-4 col-md-6 col-6">
                                        <div class="p-4">
                                            <h2 class="text-primary">Mesa</h1>
                                                <h3 id="mesa"></h3>
                                        </div>
                                    </div>
                                    <div class="col-lg-8 col-md-12 col-12">
                                        <div class="p-4">
                                            <h2 class="text-primary">Pases restantes</h1>
                                                <h3 id="restantes"></h3>
                                        </div>
                                    </div>

                                    <div class="col-12">
                                        <div class="d-flex align-items-center justify-content-center mt-2 pb-3">
                                            <a class="btn btn-primary btn-lg" onclick="cancelarInvitacion()">Utilizar
                                                invitación</a>
                                        </div>
                                    </div>

                                </div>
                            </div>


                        </div>
                    </div>

                </div>

            </div>

        </main>
        <!--@Page Content-->
    </div>
    <!--@#rekord-app-->
    <!--/#rekord-app -->
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-messaging.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-storage.js"></script>

    <script src="./assets/js/conexion.js?ver=1.0.12"></script>
    <script>
        var acceso = "";
        var pases = 0;
        var total_pases = 0;

        const getQueryVariable = (variable) => {
            var query = window.location.search.substring(1);
            var vars = query.split("&");
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split("=");
                if (pair[0] == variable) {
                    return pair[1];
                }
            }
            return (false);
        }

        const valores = window.location.search;
        const urlParams = new URLSearchParams(valores);
        var invitacionParam = urlParams.get('invitacion');

        db.collection("col-invitaciones").doc('contrasenia')
            .onSnapshot({
                // Listen for document metadata changes
                includeMetadataChanges: true
            }, (doc) => {
                (async () => {
                    const { value: password } = await Swal.fire({
                        title: 'Ingresa la contraseña',
                        input: 'password',
                        inputPlaceholder: '',
                        confirmButtonText: 'Entrar',
                        allowOutsideClick: false,
                        inputAttributes: {
                            maxlength: 10,
                            autocapitalize: 'off',
                            autocorrect: 'off'
                        }, inputValidator: (value) => {
                            if (value != doc.data().password) {
                                return 'Contraseña incorrecta'
                            }
                        }
                    });



                    if (password == doc.data().password) {
                        acceso = doc.data().password;
                        // Mostrar Invitacion



                        db.collection("col-invitaciones").doc(invitacionParam).get().then((doc_inv) => {

                            document.querySelector('#familia').innerHTML = doc_inv.data().familia;
                            document.querySelector('#pases').innerHTML = doc_inv.data().pases;
                            document.querySelector('#adultos').innerHTML = doc_inv.data().adultos;
                            document.querySelector('#ninos').innerHTML = doc_inv.data().ninos;
                            document.querySelector('#mesa').innerHTML = doc_inv.data().mesa;
                            document.querySelector('#restantes').innerHTML = doc_inv.data().totalPases;
                            pases = doc_inv.data().pases;
                            total_pases = doc_inv.data().totalPases;
                            if (doc_inv.data().totalPases == 0) {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Invitación utilizada',
                                    text: 'No dejes pasar a estas personas, ya que la invitación ya fue usada',
                                    showCancelButton: false,
                                    showConfirmButton: false,
                                    allowOutsideClick: false,
                                })
                            }
                        });
                    } else {
                        return false;
                    }

                })()


            });

        var validation = db.collection("col-invitaciones").doc('contrasenia');
        var invitacion_col = db.collection("col-invitaciones").doc(invitacionParam);

        const cancelarInvitacion = () => {

            validation.get().then((doc) => {
                if (acceso == doc.data().password) {
                    (async () => {

                        const { value: pregunta } = await Swal.fire({
                            title: '¿Aún faltan personas de esta invitación ?',
                            input: 'select',
                            inputOptions: {
                                'si': 'Si',
                                'no': 'No',
                            },
                            inputPlaceholder: 'Selecciona una opción',
                            showCancelButton: false,
                            confirmButtonText: 'Siguiente',
                            inputValidator: (value) => {

                                console.log(value);
                                if (value == 'si') {

                                    (async () => {
                                        const { value: personas } = await Swal.fire({
                                            title: '¿Cuántas personas faltan?',
                                            input: 'number',
                                            inputPlaceholder: '',
                                            confirmButtonText: 'Siguiente',
                                            allowOutsideClick: false,
                                            inputAttributes: {
                                                maxlength: 10,
                                                autocapitalize: 'off',
                                                autocorrect: 'off'
                                            }, inputValidator: (value) => {
                                                if (!value) {
                                                    return 'Es necesario que especifiques cuantas faltan'
                                                } else if (value > total_pases) {
                                                    return `Error de número de pases, no tiene esa cantidad de pases, el invitado solo tiene ${total_pases} pases`
                                                }
                                            }
                                        });


                                        invitacion_col.update({
                                            totalPases: total_pases - parseInt(personas),
                                            pasesGastados: parseInt(personas),
                                        }).then(() => {
                                            Swal.fire({
                                                title: 'Invitación utilizada con éxito',
                                                text: 'Puedes dejarlos entrar',
                                                imageUrl: 'https://firebasestorage.googleapis.com/v0/b/victoria-637cb.appspot.com/o/11272-party-popper.gif?alt=media&token=4c1d7634-b711-4613-a80a-f7e95cf23729',
                                                imageWidth: 400,
                                                imageHeight: 200,
                                                confirmButtonText: 'Aceptar',
                                                imageAlt: 'Custom image',
                                            });
                                        }).catch((error) => {
                                            // The document probably doesn't exist.
                                            console.error("Error updating document: ", error);
                                        });


                                    })()

                                } else if (value == 'no') {

                                    invitacion_col.update({
                                        totalPases: 0,
                                        pasesGastados: parseInt(pases),
                                    }).then(() => {
                                        Swal.fire({
                                            title: 'Invitación utilizada con éxito',
                                            text: 'Puedes dejarlos entrar',
                                            imageUrl: 'https://firebasestorage.googleapis.com/v0/b/victoria-637cb.appspot.com/o/11272-party-popper.gif?alt=media&token=4c1d7634-b711-4613-a80a-f7e95cf23729',
                                            imageWidth: 400,
                                            imageHeight: 200,
                                            confirmButtonText: 'Aceptar',
                                            imageAlt: 'Custom image',
                                        });
                                    }).catch((error) => {
                                        // The document probably doesn't exist.
                                        console.error("Error updating document: ", error);
                                    });

                                }

                            }
                        })



                    })()

                }
            }).catch((error) => {
                console.log("Error getting document:", error);
            });


        }
    </script>

    <script src="./assets/js/app.js"></script>

    <script src="./assets/js/loading.js"></script>


</body>

</html>